<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends List</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Friends</h1>
    <div>
		{% csrf_token %}
        <input type="text" id="friend-nickname" placeholder="Enter friend's nickname">
        <button id="add-friend-btn">Send</button>
    </div>
    
    <h2>Friend List</h2>
    <ul id="friend-list">
        <!-- Friend list items will be appended here -->
    </ul>

    <h2>Friend Requests</h2>
    <ul id="friend-request-list">
        <!-- Friend request list items will be appended here -->
    </ul>

    <script>
		$(document).ready(function() {
            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');
            // Function to add a friend
            $('#add-friend-btn').click(function() {
                const nickname = $('#friend-nickname').val();
                if (nickname) {
                    $.ajax({
                        url: 'http://localhost:8000/api/user/friend/',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ friend: nickname }),
						beforeSend: function(xhr) {
                            xhr.setRequestHeader('X-CSRFToken', csrftoken);
                        },
                        success: function(response) {
                            alert('Friend added successfully!');
                            $('#friend-nickname').val('');  // Clear input field
                            loadFriendList();  // Reload the friend list
                        },
                        error: function(xhr, status, error) {
                            alert('Failed to add friend: ' + xhr.responseText);
                        }
                    });
                } else {
                    alert('Please enter a nickname.');
                }
            });

            // Function to load the friend list
            function loadFriendList() {
                $.ajax({
                    url: 'http://localhost:8000/api/user/friend/',
                    type: 'GET',
                    success: function(response) {
                        const friendList = response.friend;
                        $('#friend-list').empty();  // Clear existing list
                        friendList.forEach(function(friend) {
                            $('#friend-list').append('<li>' + friend + '</li>');
                        });
                    },
                    error: function(xhr, status, error) {
                        alert('Failed to load friend list: ' + xhr.responseText);
                    }
                });
            }

            // Function to load friend request list
            function loadFriendRequestList() {
                $.ajax({
                    url: 'http://localhost:8000/api/user/friend-request/',
                    type: 'GET',
                    success: function(response) {
                        const requestList = response.requests;
                        $('#friend-request-list').empty();  // Clear existing list
                        requestList.forEach(function(request) {
                            $('#friend-request-list').append('<li>' + request + 
                                ' <button class="accept-request-btn" data-nickname="' + request + '">Accept</button></li>');
                        });

                        // Attach event listeners to accept buttons
                        $('.accept-request-btn').click(function() {
                            const nickname = $(this).data('nickname');
                            $.ajax({
                                url: 'http://localhost:8000/api/user/friend-request/',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({ nickname: nickname }),
								beforeSend: function(xhr) {
									xhr.setRequestHeader('X-CSRFToken', csrftoken);
								},
                                success: function(response) {
                                    alert('Friend request accepted!');
                                    loadFriendRequestList();  // Reload the friend request list
                                    loadFriendList();  // Reload the friend list
                                },
                                error: function(xhr, status, error) {
                                    alert('Failed to accept friend request: ' + xhr.responseText);
                                }
                            });
                        });
                    },
                    error: function(xhr, status, error) {
                        alert('Failed to load friend request list: ' + xhr.responseText);
                    }
                });
            }

            // Initial load of the friend and request lists
            loadFriendList();
            loadFriendRequestList();
        });
    </script>
</body>
</html>
